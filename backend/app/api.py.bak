from fastapi import APIRouter, HTTPException, Body
from pydantic import BaseModel
from .rag.ingest import build_index
from .rag.retrieval import retrieve

router = APIRouter()

class QueryBody(BaseModel):
    query: str
    top_k: int = 4

@router.get('/health')
async def health():
    return {'status': 'ok'}

@router.post('/ingest')
async def ingest_endpoint():
    try:
        res = build_index()
        return res
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post('/query')
async def query_endpoint(body: QueryBody = Body(...)):
    try:
        results = await retrieve(body.query, top_k=body.top_k)
        return {'results': results}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
